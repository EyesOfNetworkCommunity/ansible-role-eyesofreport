---
# vim: set bs=2 sw=2 expandtab:
#
# Install BIRT reporting java application
#
# Eric Belhomme <rico-github@ricozome.net> - 2018-07-22

## use get_url module if source file is a HTTP URI
#- name: download Birt runtime package on target system
#  get_url:
#    url: "{{ third_party.birt.uri }}"
#    dest: "{{ eor_tmp_install_path }}/{{ third_party.birt.filename }}"
#    mode: 0644
#    checksum: "{{ third_party.birt.sum }}"
#  when: third_party.birt.uri|regex_search('https{0,1}:\/\/')
#  register: download_birt
## or use file copy
#- name: copy Birt runtime package on target system
#  copy:
#    url: "{{ third_party.birt.uri }}"
#    dedest: "{{ eor_tmp_install_path }}/{{ third_party.birt.filename }}"
#    mode: 0644
#    checksum: "{{ third_party.birt.sum }}"
#  when: not download_birt
#  register: copy_birt
- name: get BIRT package
  include_tasks: get_third_party_package.yml
  vars:
    file_uri: "{{ third_party.birt.uri }}"
    checksum: "{{ third_party.birt.sum }}"
    
- name: create temporary directory for birt runtime extraction
  file:
    path: "{{ item }}"
    state: directory
  with_items:
  - "{{ eor_tmp_install_path }}/birt/runtime"
  - "{{ eor_tmp_install_path }}/birt/war"

- name: uncompress Birt archive in a temporary directory
  unarchive:
    src: "{{ eor_tmp_install_path }}/{{ third_party.birt.uri | basename }}"
    dest: "{{ eor_tmp_install_path }}/birt/runtime"
    remote_src: yes

- name: find Birt WAR file
  find:
    paths: "{{ eor_tmp_install_path }}/birt/runtime"
    patterns: 'birt.war'
    recurse: yes
  register: find_war

- block:

  - name: uncompress Birt WAR file in a temp dir
    unarchive:
      src: "{{ find_war.files[0].path }}"
      dest: "{{ eor_tmp_install_path }}/birt/war"
      remote_src: yes

  - name: copy MySQL java connector on Birt war
    copy:
      src: "{{ eor_install_path }}/mysql-java-connector/{{ eor_mysql_connector_java_path | basename }}"
      dest: "{{ eor_tmp_install_path }}/birt/war/WEB-INF/lib"
      remote_src: yes

  - name: copy bmrt.rptdesign template on Birt war
    template:
      src: birt/bmrt.rptdesign.j2
      dest: "{{ eor_tmp_install_path }}/birt/war/bmrt.rptdesign"

  - name: patch web.xml file on Birt war
    blockinfile:
      path: "{{ eor_tmp_install_path }}/birt/war/WEB-INF/web.xml"
      block: |
        <context-param>
          <param-name>BIRT_VIEWER_WORKING_FOLDER</param-name>
          <param-value>/srv/eyesofreport/report/</param-value>
        </context-param>

  - name: compress patched birt WAR file
    archive:
      path: "{{ eor_tmp_install_path }}/birt/war/*"
      dest: "{{ wildfly.app_path }}/wildfly/standalone/deployments/birt.war"
      format: zip
      owner: "{{ wildfly.user }}"
      group: "{{ wildfly.group }}"
      mode: 0640
  when: find_war.matched == 1